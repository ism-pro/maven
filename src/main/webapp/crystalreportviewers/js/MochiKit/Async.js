if(typeof(dojo)!="undefined"){dojo.provide("MochiKit.Async");dojo.require("MochiKit.Base")}if(typeof(JSAN)!="undefined"){JSAN.use("MochiKit.Base",[])}try{if(typeof(MochiKit.Base)=="undefined"){throw""}}catch(e){throw"MochiKit.Async depends on MochiKit.Base!"}if(typeof(MochiKit.Async)=="undefined"){MochiKit.Async={}}MochiKit.Async.NAME="MochiKit.Async";MochiKit.Async.VERSION="1.4";MochiKit.Async.__repr__=function(){return"["+this.NAME+" "+this.VERSION+"]"};MochiKit.Async.toString=function(){return this.__repr__()};MochiKit.Async.Deferred=function(a){this.chain=[];this.id=this._nextId();this.fired=-1;this.paused=0;this.results=[null,null];this.canceller=a;this.silentlyCancelled=false;this.chained=false};MochiKit.Async.Deferred.prototype={repr:function(){var a;if(this.fired==-1){a="unfired"}else{if(this.fired===0){a="success"}else{a="error"}}return"Deferred("+this.id+", "+a+")"},toString:MochiKit.Base.forwardCall("repr"),_nextId:MochiKit.Base.counter(),cancel:function(){var a=MochiKit.Async;if(this.fired==-1){if(this.canceller){this.canceller(this)}else{this.silentlyCancelled=true}if(this.fired==-1){this.errback(new a.CancelledError(this))}}else{if((this.fired===0)&&(this.results[0] instanceof a.Deferred)){this.results[0].cancel()}}},_resback:function(a){this.fired=((a instanceof Error)?1:0);this.results[this.fired]=a;this._fire()},_check:function(){if(this.fired!=-1){if(!this.silentlyCancelled){throw new MochiKit.Async.AlreadyCalledError(this)}this.silentlyCancelled=false;return}},callback:function(a){this._check();if(a instanceof MochiKit.Async.Deferred){throw new Error("Deferred instances can only be chained if they are the result of a callback")}this._resback(a)},errback:function(b){this._check();var a=MochiKit.Async;if(b instanceof a.Deferred){throw new Error("Deferred instances can only be chained if they are the result of a callback")}if(!(b instanceof Error)){b=new a.GenericError(b)}this._resback(b)},addBoth:function(a){if(arguments.length>1){a=MochiKit.Base.partial.apply(null,arguments)}return this.addCallbacks(a,a)},addCallback:function(a){if(arguments.length>1){a=MochiKit.Base.partial.apply(null,arguments)}return this.addCallbacks(a,null)},addErrback:function(a){if(arguments.length>1){a=MochiKit.Base.partial.apply(null,arguments)}return this.addCallbacks(null,a)},addCallbacks:function(a,b){if(this.chained){throw new Error("Chained Deferreds can not be re-used")}this.chain.push([a,b]);if(this.fired>=0){this._fire()}return this},_fire:function(){var g=this.chain;var j=this.fired;var c=this.results[j];var b=this;var a=null;while(g.length>0&&this.paused===0){var k=g.shift();var i=k[j];if(i===null){continue}try{c=i(c);j=((c instanceof Error)?1:0);if(c instanceof MochiKit.Async.Deferred){a=function(f){b._resback(f);b.paused--;if((b.paused===0)&&(b.fired>=0)){b._fire()}};this.paused++}}catch(h){j=1;if(!(h instanceof Error)){h=new MochiKit.Async.GenericError(h)}c=h}}this.fired=j;this.results[j]=c;if(a&&this.paused){c.addBoth(a);c.chained=true}}};MochiKit.Base.update(MochiKit.Async,{evalJSONRequest:function(){return eval("("+arguments[0].responseText+")")},succeed:function(a){var b=new MochiKit.Async.Deferred();b.callback.apply(b,arguments);return b},fail:function(a){var b=new MochiKit.Async.Deferred();b.errback.apply(b,arguments);return b},getXMLHttpRequest:function(){var a=arguments.callee;if(!a.XMLHttpRequest){var g=[function(){return new XMLHttpRequest()},function(){return new ActiveXObject("Msxml2.XMLHTTP")},function(){return new ActiveXObject("Microsoft.XMLHTTP")},function(){return new ActiveXObject("Msxml2.XMLHTTP.4.0")},function(){throw new MochiKit.Async.BrowserComplianceError("Browser does not support XMLHttpRequest")}];for(var b=0;b<g.length;b++){var c=g[b];try{a.XMLHttpRequest=c;return c()}catch(f){}}}return a.XMLHttpRequest()},_xhr_onreadystatechange:function(g){var a=MochiKit.Base;if(this.readyState==4){try{this.onreadystatechange=null}catch(f){try{this.onreadystatechange=a.noop}catch(f){}}var b=null;try{b=this.status;if(!b&&a.isNotEmpty(this.responseText)){b=304}}catch(f){}if(b==200||b==304){g.callback(this)}else{var c=new MochiKit.Async.XMLHttpRequestError(this,"Request failed");if(c.number){g.errback(c)}else{g.errback(c)}}}},_xhr_canceller:function(a){try{a.onreadystatechange=null}catch(b){try{a.onreadystatechange=MochiKit.Base.noop}catch(b){}}a.abort()},sendXMLHttpRequest:function(f,c){if(typeof(c)=="undefined"||c===null){c=""}var a=MochiKit.Base;var b=MochiKit.Async;var h=new b.Deferred(a.partial(b._xhr_canceller,f));try{f.onreadystatechange=a.bind(b._xhr_onreadystatechange,f,h);f.send(c)}catch(g){try{f.onreadystatechange=null}catch(i){}h.errback(g)}return h},doSimpleXMLHttpRequest:function(f){var c=MochiKit.Async;var g=c.getXMLHttpRequest();if(arguments.length>1){var b=MochiKit.Base;var a=b.queryString.apply(null,b.extend(null,arguments,1));if(a){f+="?"+a}}g.open("GET",f,true);return c.sendXMLHttpRequest(g)},loadJSONDoc:function(b){var a=MochiKit.Async;var c=a.doSimpleXMLHttpRequest.apply(a,arguments);c=c.addCallback(a.evalJSONRequest);return c},wait:function(g,c){var f=new MochiKit.Async.Deferred();var a=MochiKit.Base;if(typeof(c)!="undefined"){f.addCallback(function(){return c})}var b=setTimeout(a.bind("callback",f),Math.floor(g*1000));f.canceller=function(){try{clearTimeout(b)}catch(h){}};return f},callLater:function(f,b){var a=MochiKit.Base;var c=a.partial.apply(a,a.extend(null,arguments,1));return MochiKit.Async.wait(f).addCallback(function(g){return c()})}});MochiKit.Async.DeferredLock=function(){this.waiting=[];this.locked=false;this.id=this._nextId()};MochiKit.Async.DeferredLock.prototype={__class__:MochiKit.Async.DeferredLock,acquire:function(){d=new MochiKit.Async.Deferred();if(this.locked){this.waiting.push(d)}else{this.locked=true;d.callback(this)}return d},release:function(){if(!this.locked){throw TypeError("Tried to release an unlocked DeferredLock")}this.locked=false;if(this.waiting.length>0){this.locked=true;this.waiting.shift().callback(this)}},_nextId:MochiKit.Base.counter(),repr:function(){var a;if(this.locked){a="locked, "+this.waiting.length+" waiting"}else{a="unlocked"}return"DeferredLock("+this.id+", "+a+")"},toString:MochiKit.Base.forwardCall("repr")};MochiKit.Async.DeferredList=function(j,h,b,f,l){MochiKit.Async.Deferred.apply(this,[l]);this.list=j;var a=[];this.resultList=a;this.finishedCount=0;this.fireOnOneCallback=h;this.fireOnOneErrback=b;this.consumeErrors=f;var c=MochiKit.Base.bind(this._cbDeferred,this);for(var g=0;g<j.length;g++){var k=j[g];a.push(undefined);k.addCallback(c,g,true);k.addErrback(c,g,false)}if(j.length===0&&!h){this.callback(this.resultList)}};MochiKit.Async.DeferredList.prototype=new MochiKit.Async.Deferred();MochiKit.Async.DeferredList.prototype._cbDeferred=function(b,c,a){this.resultList[b]=[c,a];this.finishedCount+=1;if(this.fired!==0){if(c&&this.fireOnOneCallback){this.callback([b,a])}else{if(!c&&this.fireOnOneErrback){this.errback(a)}else{if(this.finishedCount==this.list.length){this.callback(this.resultList)}}}}if(!c&&this.consumeErrors){a=null}return a};MochiKit.Async.gatherResults=function(a){var b=new MochiKit.Async.DeferredList(a,false,true,false);b.addCallback(function(g){var c=[];for(var f=0;f<g.length;f++){c.push(g[f][1])}return c});return b};MochiKit.Async.maybeDeferred=function(f){var b=MochiKit.Async;var a;try{var c=f.apply(null,MochiKit.Base.extend([],arguments,1));if(c instanceof b.Deferred){a=c}else{if(c instanceof Error){a=b.fail(c)}else{a=b.succeed(c)}}}catch(g){a=b.fail(g)}return a};MochiKit.Async.EXPORT=["AlreadyCalledError","CancelledError","BrowserComplianceError","GenericError","XMLHttpRequestError","Deferred","succeed","fail","getXMLHttpRequest","doSimpleXMLHttpRequest","loadJSONDoc","wait","callLater","sendXMLHttpRequest","DeferredLock","DeferredList","gatherResults","maybeDeferred"];MochiKit.Async.EXPORT_OK=["evalJSONRequest"];MochiKit.Async.__new__=function(){var a=MochiKit.Base;var b=a.partial(a._newNamedError,this);b("AlreadyCalledError",function(c){this.deferred=c});b("CancelledError",function(c){this.deferred=c});b("BrowserComplianceError",function(c){this.message=c});b("GenericError",function(c){this.message=c});b("XMLHttpRequestError",function(c,g){this.req=c;this.message=g;try{this.number=c.status}catch(f){}});this.EXPORT_TAGS={":common":this.EXPORT,":all":a.concat(this.EXPORT,this.EXPORT_OK)};a.nameFunctions(this)};MochiKit.Async.__new__();MochiKit.Base._exportSymbols(this,MochiKit.Async);