bobj.crv.params.ParameterController=function(b,e,a){this._panel=b;this._viewerCtrl=e;this._paramOpts=a;this._paramList=null;this._selected=null;this._selectedValueIdx=null;this._disablePanel=false;var c=MochiKit.Base.bind(this._onClickTbDeleteButton,this);var d=MochiKit.Base.bind(this._onClickTbApplyButton,this);this._panel.setToolbarCallBacks(c,d)};bobj.crv.params.ParameterController.prototype={setParameters:function(r){var a=bobj.crv.params.DataTypes;var b=MochiKit.Base.map;var l=MochiKit.Base.bind;this._deleteWidgets();this._paramList=r;this._selected=null;this._selectedValueIdx=null;for(var h=0;h<r.length;++h){var e=r[h];var n=l(this._onParamHasDupValue,this,e);var p=l(this._onParamHasNoDupValue,this,e);e.addDuplicateValuesCB(n,p);var m=l(this._getDisplayText,this,e);var f=l(this._getDefaultValue,this,e.valueDataType,e.defaultDisplayType);var g=this._canPanelChangeValues(e);var o=this._getMinMaxText(e.valueDataType,e.minValue,e.maxValue);var q=MochiKit.Base.bind(this._onClickTbAdvButton,this);var j=!e.isEditable;var d=e.getValue();var k=this._viewerCtrl.getCurrentView();if(k&&!k.isMainReport()){this._disablePanel=true;j=true;g=false}if(e.allowNullValue==true&&d!=null&&d.length==1&&d[0]==null){d=[]}var c=bobj.crv.params.newParameterUI({values:b(m,d),canChangeOnPanel:g,allowCustom:e.allowCustomValue,canAddValues:e.allowMultiValue&&g,isReadOnlyParam:j,isPassword:e.isPassword(),valueRequired:(!e.isOptionalPrompt&&!e.allowNullValue),defaultValues:b(f,e.defaultValues||[]),hasRowButtons:e.allowCustomValue&&g&&(e.valueDataType===a.DATE||e.valueDataType===a.DATE_TIME),rowButtonsUrl:bobj.crvUri("images/calendar.gif"),openAdvDialogCB:q,maxNumParameterDefaultValues:this._paramOpts.maxNumParameterDefaultValues,tooltip:e.getTitle()});this._observeParamWidget(c);this._panel.addParameter({paramUI:c,label:e.getTitle(),isDataFetching:e.isDataFetching,isReadOnly:!e.isEditable,isDirty:false,selectCB:l(this._onSelectValue,this,c,0),openAdvCB:j?null:q,minMaxTooltip:o})}this._panel.resize()},getParameters:function(){return this._paramList},updateParameter:function(c,e){if(c){var a=-1;for(var b=0;b<this._paramList.length;++b){if(this._paramList[b].paramName===c){this._paramList[b].setValue(e);a=b;break}}if(a!=-1){var f=this._panel.getParameter(a);var d=MochiKit.Base.bind(this._getDisplayText,this,this._paramList[a]);if(this._paramList[b].allowNullValue&&e.length==1&&e[0]==null){e=[]}f.setValues(MochiKit.Base.map(d,e));if(!f.valueRequired&&!f.canAddValues){if(e.length>0){f.showRowCreater(false)}else{f.showRowCreater(true)}}this._panel.setDirty(a,f.isDirty())}}},_canPanelChangeValues:function(a){return a&&a.isEditable&&!a.allowRangeValue&&!a.editMask&&!a.isDCP()},_deleteWidgets:function(){var a=this._panel.getParameter(0);while(a){delete _widgets[a.widx];this._panel.removeParameter(0);a=this._panel.getParameter(0)}},_compareCustomDateObject:function(b,a){if(b.y!=a.y){return false}if(b.m!=a.m){return false}if(b.d!=a.d){return false}if(b.h!=a.h){return false}if(b.min!=a.min){return false}if(b.s!=a.s){return false}if(b.ms!=a.ms){return false}return true},_hasMinBound:function(b,c){if(c==null){return false}var a=bobj.crv.params.DataTypes;switch(b){case a.STRING:if(c==0){return false}return true;case a.DATE:case a.DATE_TIME:absoluteMin={y:1753,m:0,d:1,h:0,min:0,s:0,ms:0};return !this._compareCustomDateObject(absoluteMin,c);case a.TIME:absoluteMin={y:1899,m:11,d:30,h:0,min:0,s:0,ms:0};return !this._compareCustomDateObject(absoluteMin,c);case a.NUMBER:case a.CURRENCY:if(c==-3.40282346638529e+38){return false}return true}return false},_hasMaxBound:function(b,c){if(c==null){return false}var a=bobj.crv.params.DataTypes;switch(b){case a.STRING:if(c==65534){return false}return true;case a.DATE:absoluteMax={y:9999,m:11,d:12,h:0,min:0,s:0,ms:0};return !this._compareCustomDateObject(absoluteMax,c);case a.TIME:absoluteMax={y:1899,m:11,d:30,h:23,min:59,s:59,ms:0};return !this._compareCustomDateObject(absoluteMax,c);case a.DATE_TIME:absoluteMax={y:9999,m:11,d:12,h:23,min:59,s:59,ms:0};return !this._compareCustomDateObject(absoluteMax,c);case a.NUMBER:case a.CURRENCY:if(c==3.40282346638529e+38){return false}return true}return false},_getMinMaxText:function(g,i,f){var a=bobj.crv.params.DataTypes;var j,c;if(g==a.STRING){c=this._getValueText(a.NUMBER,i);j=this._getValueText(a.NUMBER,f)}else{c=this._getValueText(g,i);j=this._getValueText(g,f)}if(g==a.BOOLEAN||(i==null&&f==null)){return null}var e,h;switch(g){case a.DATE:e=L_bobj_crv_Date;break;case a.TIME:e=L_bobj_crv_Time;break;case a.DATE_TIME:e=L_bobj_crv_DateTime;break;case a.NUMBER:e=L_bobj_crv_Number;break;case a.CURRENCY:e=L_bobj_crv_Number;break}var d=this._hasMinBound(g,i);var b=this._hasMaxBound(g,f);switch(g){case a.STRING:if(d&&b){h=L_bobj_crv_ParamsStringMinAndMaxTooltip.replace("%1",c);h=h.replace("%2",j)}else{if(d){h=L_bobj_crv_ParamsStringMinOrMaxTooltip.replace("%1",L_bobj_crv_Minimum);h=h.replace("%2",c)}else{if(b){h=L_bobj_crv_ParamsStringMinOrMaxTooltip.replace("%1",L_bobj_crv_Maximum);h=h.replace("%2",j)}}}break;default:if(d&&b){h=L_bobj_crv_ParamsMinAndMaxTooltip.replace("%1",e);h=h.replace("%2",c);h=h.replace("%3",j)}else{if(d){h=L_bobj_crv_ParamsMinTooltip.replace("%1",e);h=h.replace("%2",c)}else{if(b){h=L_bobj_crv_ParamsMaxTooltip.replace("%1",e);h=h.replace("%2",j)}}}}return h},_getDefaultValue:function(e,d,f){var a=bobj.crv.params.DefaultDisplayTypes;var c=this._getValueText(e,f.value);var b;switch(d){case a.Description:if(f.desc!=null&&f.desc.length>0){b=f.desc}else{b=c}break;case a.DescriptionAndValue:b=c;if(f.desc!=null&&f.desc.length>0){b+=" - "+f.desc}break}return b},_getValueTextFromDefValueDesc:function(d,c){if(d.defaultValues&&bobj.isArray(d.defaultValues)){for(var a=0;a<d.defaultValues.length;a++){var b=this._getDefaultValue(d.valueDataType,d.defaultDisplayType,d.defaultValues[a]);if(b==c){return this._getValueText(d.valueDataType,d.defaultValues[a].value)}}}return null},_getValueText:function(b,c){if(c===undefined){return undefined}var a=bobj.crv.params.DataTypes;switch(b){case a.DATE:return this._getDateTimeText(c,this._paramOpts.dateFormat);case a.TIME:return this._getDateTimeText(c,this._paramOpts.timeFormat);case a.DATE_TIME:return this._getDateTimeText(c,this._paramOpts.dateTimeFormat);case a.NUMBER:case a.CURRENCY:return this._getNumberText(c,this._paramOpts.numberFormat);case a.BOOLEAN:return this._getBooleanText(c,this._paramOpts.booleanFormat);case a.STRING:default:return""+c}},_getBooleanText:function(b,a){return a[""+b]},_getNumberText:function(h,g){var f=g.decimalSeperator;var a=g.groupSeperator;var j=(""+h).split(".");var i,b,e;var k=null;i=j[0];if(i.length>0&&i.slice(0,1)=="-"||i.slice(0,1)=="+"){k=i.slice(0,1);i=i.slice(1,i.length)}b=(j.length==2)?j[1]:null;formattedLeftVal=null;if(i.length<=3){formattedLeftVal=i}else{var d=null;var c=null;while(i.length>0){c=(i.length>3)?i.length-3:0;d=i.slice(c,i.length);i=i.slice(0,c);formattedLeftVal=(formattedLeftVal==null)?d:d+a+formattedLeftVal}}e=(b!=null)?formattedLeftVal+f+b:formattedLeftVal;e=(k!=null)?k+e:e;return e},_getDateTimeText:function(b,c){var a=bobj.crv.params.jsonToDate(b);if(a){return bobj.external.date.formatDate(a,c)}return""},_getValueTextFromDefaultValue:function(d,b){if(bobj.isArray(d.defaultValues)){var c=bobj.getValueHashCode(d.valueDataType,b);for(var a=0;a<d.defaultValues.length;a++){if(c==bobj.getValueHashCode(d.valueDataType,d.defaultValues[a].value)){return this._getDefaultValue(d.valueDataType,d.defaultDisplayType,d.defaultValues[a])}}}return null},_getDisplayText:function(c,b){if(b===undefined){return undefined}if(b.lowerBoundType!==undefined||b.upperBoundType!==undefined){return this._getRangeDisplayText(c,b)}var a=this._getValueTextFromDefaultValue(c,b);if(a==null){a=this._getValueText(c.valueDataType,b)}return a},_getRangeDisplayText:function(a,g){var i="";if(g.lowerBoundType!==undefined||g.upperBoundType!==undefined){var d=parseInt(g.lowerBoundType,10);var c=parseInt(g.upperBoundType,10);var h="(";var b=")";if(d==bobj.crv.params.RangeBoundTypes.INCLUSIVE){h="["}if(c==bobj.crv.params.RangeBoundTypes.INCLUSIVE){b="]"}var f="";var e="";if(d!=bobj.crv.params.RangeBoundTypes.UNBOUNDED){f=this._getDisplayText(a,g.beginValue)}if(c!=bobj.crv.params.RangeBoundTypes.UNBOUNDED){e=this._getDisplayText(a,g.endValue)}i=h+" "+f;i+=" .. ";i+=e+" "+b}else{i=this._getDisplayText(a,g)}return i},_getParamValue:function(b,c){if(b===undefined){return undefined}var a=bobj.crv.params.DataTypes;switch(b){case a.DATE:return this._getDateTimeParamValue(c,this._paramOpts.dateFormat);case a.TIME:return this._getDateTimeParamValue(c,this._paramOpts.timeFormat);case a.DATE_TIME:return this._getDateTimeParamValue(c,this._paramOpts.dateTimeFormat);case a.NUMBER:case a.CURRENCY:return this._getNumberParamValue(c,this._paramOpts.numberFormat);case a.BOOLEAN:return this._getBooleanParamValue(c,this._paramOpts.booleanFormat);case a.STRING:default:return c}},_getBooleanParamValue:function(b,a){if(b!=null&&b.length!=0){return a["true"]==b}else{return null}},_getNumberParamValue:function(d,c){if(d==null){return null}var a="";if(/[ \f\n\r\t\v\u00A0\u2028\u2029]/.test(c.groupSeperator)){a=d.replace(/[ \f\n\r\t\v\u00A0\u2028\u2029]/g,"")}else{var b=new RegExp("\\"+c.groupSeperator,"g");a=d.replace(b,"")}return a.replace(c.decimalSeperator,".")},_getDateTimeParamValue:function(c,b){var a=bobj.external.date.getDateFromFormat(c,b);if(a){return bobj.crv.params.dateToJson(a)}return c},_observeParamWidget:function(a){if(a){var b=MochiKit.Base.bind;a.changeValueCB=b(this._onChangeValue,this,a);a.addValueCB=b(this._onAddValue,this,a);a.selectValueCB=b(this._onSelectValue,this,a);a.enterPressCB=b(this._onEnterPress,this,a);a.clickRowButtonCB=b(this._onClickRowButton,this,a)}},_onParamHasDupValue:function(f,d){var c=this._findWidget(f);var b=this._getDisplayText(f,d);if(c){for(var a=0;a<c.getNumValues();a++){var e=c.getValueAt(a);if(b==e){c.setWarning(a,{code:bobj.crv.params.Validator.ValueStatus.VALUE_DUPLICATE,message:L_bobj_crv_ParamsDuplicateValue})}}}},_onParamHasNoDupValue:function(f,d){var c=this._findWidget(f);var b=this._getDisplayText(f,d);var g=bobj.crv.params.Validator.ValueStatus.VALUE_DUPLICATE;if(c){for(var a=0;a<c.getNumValues();a++){var e=c.getValueAt(a);if((arguments.length==1||b==e)&&c.getWarning(a)!=null&&c.getWarning(a).code==g){c.setWarning(a,null)}}}},_onChangeValue:function(c,a,d){if(this._disablePanel){return}c.setWarning(a,null);var b=c.isDirty();this._panel.setDirty(this._panel.getIndex(c),b);this._updateToolbar()},_onAddValue:function(a,b){if(this._disablePanel){return}this._updateToolbar();this._panel.setDirty(this._panel.getIndex(a),a.isDirty())},_onSelectValue:function(d,a){var b=this._selected;var c=this._selectedValueIdx;this._select(d,a);if(b&&bobj.isNumber(c)){this._checkAndSetValue(b,c)}},_onEnterPress:function(b,a){this._applyValues()},_onClickRowButton:function(d,b,a,h){this._setConnectedToCalendar(true);var f=bobj.crv.Calendar.getInstance();var g=this._findParam(d);var e=this._getDateTimeFormat(g.valueDataType);var c=bobj.external.date.getDateFromFormat(d.getValueAt(d.getSelectedIndex()),e);if(c){f.setDate(c)}f.setShowTime(g.valueDataType===bobj.crv.params.DataTypes.DATE_TIME);f.show(true,a,h)},_onClickCalendarOKButton:function(b){this._setConnectedToCalendar(false);if(b&&this._selected){var f=this._findParam(this._selected);var a=this._selected.getSelectedIndex();var d=this._getDateTimeFormat(f.valueDataType);var e=bobj.external.date.formatDate(b,d);this._selected.setValueAt(a,e);var c=this._selected.isDirty();this._selected.setWarning(a,null);this._panel.setDirty(this._panel.getIndex(this._selected),c);this._updateToolbar()}},_onClickCalendarCancelButton:function(){this._setConnectedToCalendar(false)},_onHideCalendar:function(){this._setConnectedToCalendar(false)},_onClickTbApplyButton:function(){this._applyValues()},_onClickTbAdvButton:function(){if(this._selected){this._viewerCtrl.showAdvancedParamDialog(this)}},_onClickTbDeleteButton:function(){if(this._selected){var a=this._selected.getSelectedIndex();this._selected.deleteValue(a);this._panel.setDirty(this._panel.getIndex(this._selected),this._selected.isDirty());this._updateToolbar();var b=this._findParam(this._selected);b.removeValueAt(a);a=Math.min(a,this._selected.getNumValues()-1);this._selected.setSelected(a);if((b.isOptionalPrompt||b.allowNullValue)&&b.getValue().length==0){this._selected.showRowCreater(true)}}},_select:function(b,a){this._selectedValueIdx=a;if(this._selected!==b){if(this._selected){this._selected.deselect()}this._selected=b;this._panel.setSelected(this._panel.getIndex(b),true);this._updateToolbar()}if(bobj.isNumber(a)){this._selected.setSelected(a)}},_applyValues:function(){this._checkAndSetValue(this._selected,this._selectedValueIdx);var d=this._paramList.length;var k=-1;var a=-1;var m=null;var b=null;for(var f=0;(f<d)&&!m;++f){b=this._panel.getParameter(f);var l=b.getNumValues();for(var e=0;(e<l)&&!m;++e){m=b.getWarning(e);if(m){k=f;a=e}}}if(m){b=this._panel.getParameter(k);this._onSelectValue(b,a);var h=bobj.crv.ErrorDialog.getInstance();h.setText(m.message,null);h.setTitle(L_bobj_crv_ParamsInvalidTitle);h.setPromptType(_promptDlgWarning);h.show(true,function(){b.setSelected(a)})}else{for(var f=0,g=this._paramList.length;f<g;f++){this._paramList[f].commitValue()}this._viewerCtrl.applyParams(this._paramList)}},_findParam:function(a){return this._paramList[this._panel.getIndex(a)]},_findWidget:function(b){for(var a=0;a<this._paramList.length;a++){if(this._paramList[a].paramName==b.paramName){return this._panel.getParameter(a)}}return null},_updateToolbar:function(){if(this._disablePanel){return}if(this._selected){var d=this._findParam(this._selected);this._panel.setDeleteButtonEnabled(this._canPanelChangeValues(d)&&(((d.isOptionalPrompt||d.allowNullValue)&&this._selected.getValues().length>0)||(d.allowMultiValue&&this._selected.getValues().length>1)))}else{this._panel.setDeleteButtonEnabled(false)}var c=false;for(var b=0,a=this._paramList.length;b<a;b++){if(this._panel.isDirty(b)){c=true;break}}this._panel.setApplyButtonEnabled(c)},_getDateTimeFormat:function(b){var a=bobj.crv.params.DataTypes;switch(b){case a.DATE:return this._paramOpts.dateFormat;case a.TIME:return this._paramOpts.timeFormat;case a.DATE_TIME:return this._paramOpts.dateTimeFormat;default:return null}},_setConnectedToCalendar:function(c){var b=c?MochiKit.Signal.connect:MochiKit.Signal.disconnect;var a=bobj.crv.Calendar.getInstance();b(a,a.Signals.OK_CLICK,this,"_onClickCalendarOKButton");b(a,a.Signals.CANCEL_CLICK,this,"_onClickCalendarCancelButton");b(a,a.Signals.ON_HIDE,this,"_onHideCalendar")},_checkAndSetValue:function(c,i){if(!c.canChangeOnPanel){return}var h=this._findParam(c);var d=c.getValueAt(i);var g=this._getValueTextFromDefValueDesc(h,d);if(g!=null){d=g}var b=this._getParamValue(h.valueDataType,d);if(i==0&&b==null&&h.getValue().length==0){if(h.allowNullValue){h.setValue(0,null)}if(h.isOptionalPrompt||h.allowNullValue){return}}var f=bobj.crv.params.Validator.ValueStatus;var a=f.OK;var j=null;a=bobj.crv.params.Validator.getInstance().validateValue(h,b);if(f.OK===a){var e=this._getValueTextFromDefaultValue(h,b);if(e!=null){c.setValueAt(i,e)}c.setWarning(i,null);h.setValue(i,b)}else{j=this._getWarningText(h,a);c.setWarning(i,{code:a,message:j})}},_getWarningText:function(c,b){var a=bobj.crv.params.DataTypes;switch(c.valueDataType){case a.DATE:case a.TIME:case a.DATE_TIME:return this._getDateTimeWarning(c,b);case a.STRING:return this._getStringWarning(c,b);case a.NUMBER:case a.CURRENCY:return this._getNumberWarning(c,b);default:return null}},_getDateTimeWarning:function(e,d){var c=bobj.crv.params.DataTypes;var b=bobj.crv.params.Validator.ValueStatus;var a=this._paramOpts.dateFormat;a=a.replace("yyyy","%1");a=a.replace("M","%2");a=a.replace("d","%3");a=a.replace("%1",L_bobj_crv_ParamsYearToken);a=a.replace("%2",L_bobj_crv_ParamsMonthToken);a=a.replace("%3",L_bobj_crv_ParamsDayToken);if(d==b.ERROR||d==b.VALUE_INVALID_TYPE){switch(e.valueDataType){case c.DATE:return L_bobj_crv_ParamsBadDate.replace("%1",a);case c.DATE_TIME:return L_bobj_crv_ParamsBadDateTime.replace("%1",a);break;case c.TIME:return L_bobj_crv_ParamsBadTime;break}}else{if(d==b.VALUE_TOO_BIG||d==b.VALUE_TOO_SMALL){return this._getMinMaxText(e.valueDataType,e.minValue,e.maxValue)}}return null},_getStringWarning:function(c,b){var a=bobj.crv.params.Validator.ValueStatus;if(a.VALUE_TOO_LONG===b){return L_bobj_crv_ParamsTooLong.replace("%1",c.maxValue)}else{if(a.VALUE_TOO_SHORT===b){return L_bobj_crv_ParamsTooShort.replace("%1",c.minValue)}}return null},_getNumberWarning:function(d,c){var b=bobj.crv.params.Validator.ValueStatus;var a=bobj.crv.params.DataTypes;switch(c){case b.ERROR:case b.VALUE_INVALID_TYPE:if(d.valueDataType==a.NUMBER){return L_bobj_crv_ParamsBadNumber}else{if(d.valueDataType==a.CURRENCY){return L_bobj_crv_ParamsBadCurrency}}case b.VALUE_TOO_BIG:case b.VALUE_TOO_SMALL:return this._getMinMaxText(d.valueDataType,d.minValue,d.maxValue);default:return null}}};