if(typeof(bobj.crv.Async)=="undefined"){bobj.crv.Async={}}bobj.crv.Async.UpdatePack=function(){this.viewer={refreshLayout:false,requiresScrolling:false,toolbar:{requiresUpdate:false},reportAlbum:{updateTabs:false,reportView:{reportPage:{requiresUpdate:false},toolPanel:{groupTree:{requiresUpdate:false,path:""},paramPanel:{requiresUpdate:false}}}}}};bobj.crv.Async.UpdatePack.prototype={setUpdateGroupTree:function(a){this.viewer.reportAlbum.reportView.toolPanel.groupTree.requiresUpdate=a},setRequiresScrolling:function(a){this.viewer.requiresScrolling=a},requiresScrolling:function(){return this.viewer.requiresScrolling},setGroupTreePath:function(a){this.viewer.reportAlbum.reportView.toolPanel.groupTree.path=a},updateGroupTree:function(){return this.viewer.reportAlbum.reportView.toolPanel.groupTree.requiresUpdate},groupTreePath:function(){return this.viewer.reportAlbum.reportView.toolPanel.groupTree.path},setUpdateReportPage:function(a){this.viewer.reportAlbum.reportView.reportPage.requiresUpdate=a},updateReportPage:function(){return this.viewer.reportAlbum.reportView.reportPage.requiresUpdate},setUpdateParamPanel:function(a){return this.viewer.reportAlbum.reportView.toolPanel.paramPanel.requiresUpdate},updateParamPanel:function(){return this.viewer.reportAlbum.reportView.toolPanel.paramPanel.requiresUpdate},updateToolPanel:function(){return this.updateGroupTree()||this.updateParamPanel()},updateReportAlbum:function(){return this.updateReportView()||this.viewer.reportAlbum.updateTabs},updateReportView:function(){return this.updateToolPanel()||this.updateReportPage()},setUpdateToolbar:function(a){this.viewer.toolbar.requiresUpdate=a},updateToolbar:function(){return this.viewer.toolbar.requiresUpdate},setUpdateTabs:function(a){this.viewer.reportAlbum.updateTabs=a},updateTabs:function(){return this.viewer.reportAlbum.updateTabs},refreshLayout:function(){return this.viewer.refreshLayout},setRefreshLayout:function(a){this.viewer.refreshLayout=a}};bobj.crv.ViewerListener=function(c,e){this._name=c;this._viewer=null;this._promptPage=null;this._paramCtrl=null;this._ioHandler=e;this._reportProcessing=null;var b=MochiKit.Signal.connect;var a=bobj.event.subscribe;var f=MochiKit.Base.bind;var d=getWidgetFromID(c);if(d){if(d.widgetType=="Viewer"){this._viewer=d;this._reportProcessing=this._viewer._reportProcessing}else{if(d.widgetType=="PromptPage"){this._promptPage=d;this._reportProcessing=this._promptPage._reportProcessing}}}if(this._viewer){b(this._viewer,"selectView",this,"_onSelectView");b(this._viewer,"removeView",this,"_onRemoveView");b(this._viewer,"firstPage",this,"_onFirstPage");b(this._viewer,"prevPage",this,"_onPrevPage");b(this._viewer,"nextPage",this,"_onNextPage");b(this._viewer,"lastPage",this,"_onLastPage");b(this._viewer,"selectPage",this,"_onSelectPage");b(this._viewer,"zoom",this,"_onZoom");b(this._viewer,"drillUp",this,"_onDrillUp");b(this._viewer,"refresh",this,"_onRefresh");b(this._viewer,"search",this,"_onSearch");b(this._viewer,"export",this,"_onExport");b(this._viewer,"print",this,"_onPrint");b(this._viewer,"resizeToolPanel",this,"_onResizeToolPanel");b(this._viewer,"hideToolPanel",this,"_onHideToolPanel");b(this._viewer,"grpDrilldown",this,"_onDrilldownGroupTree");b(this._viewer,"grpNodeRetrieveChildren",this,"_onRetrieveGroupTreeNodeChildren");b(this._viewer,"grpNodeCollapse",this,"_onCollapseGroupTreeNode");b(this._viewer,"grpNodeExpand",this,"_onExpandGroupTreeNode");b(this._viewer,"showParamPanel",this,"_onShowParamPanel");b(this._viewer,"showGroupTree",this,"_onShowGroupTree");b(this._viewer,"printSubmitted",this,"_onSubmitExport");b(this._viewer,"exportSubmitted",this,"_onSubmitExport");this._setInteractiveParams()}a("drilldown",this._forwardTo("_onDrilldown"));a("drilldownGraph",this._forwardTo("_onDrilldownGraph"));a("drilldownSubreport",this._forwardTo("_onDrilldownSubreport"));a("sort",this._forwardTo("_onSort"));a("hyperlinkClicked",this._forwardTo("_onHyperlinkClicked"));a("crprompt_param",this._forwardTo("_onSubmitStaticPrompts"));a("crprompt_pmtEngine",this._forwardTo("_onSubmitPromptEnginePrompts"));a("crprompt_logon",this._forwardTo("_onSubmitDBLogon"));a("crprompt_cancel",this._forwardTo("_onCancelParamDlg"));a("crprompt_flexparam",this._forwardTo("_onFlexParam"));a("crprompt_flexlogon",this._forwardTo("_onFlexLogon"));a("pnav",this._forwardTo("_onNavigateReportPart"));a("navbookmark",this._forwardTo("_onNavigateBookmark"));a("saveViewState",f(this._onSaveViewState,this))};bobj.crv.ViewerListener.prototype={getCurrentView:function(){if(this._viewer&&this._viewer._reportAlbum){return this._viewer._reportAlbum.getSelectedView()}return null},_forwardTo:function(a){return MochiKit.Base.bind(function(c){if(c==this._name){var b=bobj.slice(arguments,1);this[a].apply(this,b)}},this)},_onSaveViewState:function(){this._saveViewState()},_onSelectView:function(a){if(a){bobj.crv.logger.info("UIAction View.Select");if(a.hasContent()){this._updateUIState()}else{var b=bobj.crv.stateManager.getComponentState(this._name);if(b){b.curViewId=a.viewStateId;this._request({selectView:a.viewStateId},false)}}}},_onRemoveView:function(c){if(c){bobj.crv.logger.info("UIAction View.Remove");var b=bobj.crv.stateManager.getComponentState(this._name);if(b){delete b[c.viewStateId]}var d=this._getCommonState();if(d){var a=MochiKit.Base.findValue(d.rptAlbumOrder,c.viewStateId);if(a!=-1){arrayRemove(d,"rptAlbumOrder",a)}}}},_getPageNavigationUpdatePack:function(){var a=new bobj.crv.Async.UpdatePack();a.setUpdateReportPage(true);a.setUpdateToolbar(true);a.setRefreshLayout(true);return a},_onFirstPage:function(){bobj.crv.logger.info("UIAction Toolbar.FirstPage");this._request({tb:"first"},bobj.crv.config.useAsync,true,this._getPageNavigationUpdatePack())},_onPrevPage:function(){bobj.crv.logger.info("UIAction Toolbar.PrevPage");this._request({tb:"prev"},bobj.crv.config.useAsync,true,this._getPageNavigationUpdatePack())},_onNextPage:function(){bobj.crv.logger.info("UIAction Toolbar.NextPage");this._request({tb:"next"},bobj.crv.config.useAsync,true,this._getPageNavigationUpdatePack())},_onLastPage:function(){bobj.crv.logger.info("UIAction Toolbar.LastPage");this._request({tb:"last"},bobj.crv.config.useAsync,true,this._getPageNavigationUpdatePack())},_onDrillUp:function(){bobj.crv.logger.info("UIAction Toolbar.DrillUp");this._request({tb:"drillUp"},false)},_onSelectPage:function(a){bobj.crv.logger.info("UIAction Toolbar.SelectPage "+a);this._request({tb:"gototext",text:a},bobj.crv.config.useAsync,true,this._getPageNavigationUpdatePack())},_onZoom:function(b){bobj.crv.logger.info("UIAction Toolbar.Zoom "+b);var a=new bobj.crv.Async.UpdatePack();a.setUpdateReportPage(true);a.setRefreshLayout(true);this._request({tb:"zoom",value:b},bobj.crv.config.useAsync,true,a)},_onExport:function(){if(this._viewer._export){bobj.crv.logger.info("UIAction Toolbar.Export");this._viewer._export.show(true)}},_onPrint:function(){var a=this._viewer._print;if(a){if(a.isActxPrinting){bobj.crv.logger.info("UIAction Toolbar.Print ActiveX");var c=bobj.crv.stateManager.getCompositeState();var b=this._ioHandler.getPostDataForPrinting(c,this._name);this._viewer._print.show(true,b)}else{bobj.crv.logger.info("UIAction Toolbar.Print PDF");this._viewer._print.show(true)}}},_onResizeToolPanel:function(a){this._setCommonProperty("toolPanelWidth",a);this._setCommonProperty("toolPanelWidthUnit","px")},_onHideToolPanel:function(){bobj.crv.logger.info("UIAction Toolbar.HideToolPanel");this._setCommonProperty("toolPanelType",bobj.crv.ToolPanelType.None)},_onShowParamPanel:function(){bobj.crv.logger.info("UIAction Toolbar.ShowParamPanel");this._setCommonProperty("toolPanelType",bobj.crv.ToolPanelType.ParameterPanel)},_onShowGroupTree:function(){bobj.crv.logger.info("UIAction Toolbar.ShowGroupTree");this._setCommonProperty("toolPanelType",bobj.crv.ToolPanelType.GroupTree)},_onDrilldown:function(a){bobj.crv.logger.info("UIAction Report.Drilldown");this._request(a,false)},_onDrilldownSubreport:function(a){bobj.crv.logger.info("UIAction Report.DrilldownSubreport");this._request(a,false)},_onDrilldownGraph:function(a,g,j,h,f,i,k,d){if(a){bobj.crv.logger.info("UIAction Report.DrilldownGraph");var e,c;if(_ie||_saf){e=a.offsetX;c=a.offsetY}else{e=a.layerX;c=a.layerY}var b=parseInt(this._getCommonProperty("zoom"),10);b=(isNaN(b)?1:b/100);this._request({name:encodeURIComponent(g),brch:j,coord:(e*d/b+parseInt(h,10))+"-"+(c*d/b+parseInt(f,10)),pagenumber:i,nextpart:encodeURIComponent(k)},false)}},_onDrilldownGroupTree:function(e,c,b){bobj.crv.logger.info("UIAction GroupTree.Drilldown");var d=encodeURIComponent(e);if(!b){this._request({brch:c,drillname:d},false)}else{var a=new bobj.crv.Async.UpdatePack();a.setUpdateReportPage(true);a.setRequiresScrolling(true);a.setUpdateToolbar(true);this._request({grp:c,drillname:d},bobj.crv.config.useAsync,true,a)}},_onRetrieveGroupTreeNodeChildren:function(b){var a=new bobj.crv.Async.UpdatePack();a.setUpdateGroupTree(true);a.setGroupTreePath(b);this._request({grow:b},bobj.crv.config.useAsync,true,a)},_onCollapseGroupTreeNode:function(e){bobj.crv.logger.info("UIAction GroupTree.CollapseNode");var d=this.getCurrentExpandedPaths();var b=e.split("-");for(var c=0,a=b.length-1;c<=a;c++){var f=b[c];if(d[f]){if(c==a){delete d[f];return}d=d[f]}else{return}}},_onExpandGroupTreeNode:function(e){bobj.crv.logger.info("UIAction GroupTree.ExpandNode");var d=this.getCurrentExpandedPaths();var b=e.split("-");for(var c=0,a=b.length;c<a;c++){var f=b[c];if(!d[f]){d[f]={}}d=d[f]}},_onRefresh:function(){bobj.crv.logger.info("UIAction Toolbar.Refresh");this._request({tb:"refresh"},false)},_onSearch:function(b){bobj.crv.logger.info("UIAction Toolbar.Search");var a=new bobj.crv.Async.UpdatePack();a.setUpdateReportPage(true);a.setUpdateToolbar(true);a.setRequiresScrolling(true);this._request({tb:"search",text:encodeURIComponent(b)},bobj.crv.config.useAsync,true,a)},_onFlexParam:function(a){this._request({crprompt:"flexPromptingSetValues",paramList:a},false)},_onFlexLogon:function(c){for(var b=0,a=c.length;b<a;b++){this._addRequestField(c[b].field,c[b].value)}this._request({crprompt:"logon"},false)},_onSubmitPromptEnginePrompts:function(i){var g=(this._viewer&&this._viewer._promptDlg&&this._viewer._promptDlg.isVisible());var e=g;var c="ValueID"+this._name;var d="ContextID"+this._name;var b="ContextHandleID"+this._name;var f=document.getElementById(c);if(f){this._addRequestField(c,f.value)}var h=document.getElementById(d);if(h){this._addRequestField(d,h.value)}var a=document.getElementById(b);if(a){this._addRequestField(b,a.value)}this._request({crprompt:"pmtEngine",isAdvancedDialog:g},e);this._removeRequestField(c);this._removeRequestField(d);this._removeRequestField(b)},_onSubmitStaticPrompts:function(a){this._addRequestFields(a);this._request({crprompt:"param"},false)},_onSubmitDBLogon:function(a){this._addRequestFieldsFromContent(this._promptPage.contentId);this._request({crprompt:"logon"},false)},_onSubmitExport:function(f,a,d){var b=true;if(!f&&!a){b=false}if(!d){d="PDF"}var c={tb:"crexport",text:d,range:b+""};if(b){c.from=f+"";c.to=a+""}bobj.crv.logger.info("UIAction Export.Submit "+d);if(this._ioHandler instanceof bobj.crv.ServletAdapter||this._ioHandler instanceof bobj.crv.FacesAdapter){this._ioHandler.redirectToServlet();this._ioHandler.addRequestField("ServletTask","Export")}var e=null;this._request(c,false,false)},_onCancelParamDlg:function(){bobj.crv.logger.info("UIAction PromptDialog.Cancel");this._viewer.hidePromptDialog()},_onReceiveParamDlg:function(a){this._viewer.showPromptDialog(a)},_onSort:function(a){bobj.crv.logger.info("UIAction Report.Sort");this._request(a,false)},_onNavigateReportPart:function(a){bobj.crv.logger.info("UIAction ReportPart.Navigate");this._request(a,false)},_onNavigateBookmark:function(a){bobj.crv.logger.info("UIAction Report.Navigate");this._request(a,false)},getCurrentExpandedPaths:function(){var a=this._getViewState();if(a){return a.gpTreeCurrentExpandedPaths}return{}},applyParams:function(a){if(a){bobj.crv.logger.info("UIAction ParameterPanel.Apply");if(this._ioHandler instanceof bobj.crv.ServletAdapter||this._ioHandler instanceof bobj.crv.FacesAdapter){a=this._encodeParameters(a)}this._request({crprompt:"paramPanel",paramList:a})}},showAdvancedParamDialog:function(a){if(!a){return}var d=a._findParam(a._selected);if(!d){return}if(this._viewer.getPromptingType().toLowerCase()==bobj.crv.Viewer.PromptingTypes.FLEX){var b="";if(this._ioHandler instanceof bobj.crv.ServletAdapter||this._ioHandler instanceof bobj.crv.FacesAdapter){b=this._ioHandler._servletUrl}this._viewer.showFlexPromptDialog(a,d,b)}else{var c=MochiKit.Base.clone(d);c.defaultValues=null;if(this._ioHandler instanceof bobj.crv.ServletAdapter||this._ioHandler instanceof bobj.crv.FacesAdapter){c.value=MochiKit.Base.clone(d.value);c=this._encodeParameter(c)}this._request({promptDlg:c},true)}},_encodeParameters:function(c){if(c){for(var b=0,a=c.length;b<a;b++){c[b]=this._encodeParameter(c[b])}}return c},_encodeParameter:function(c){if(c){if(c.value&&c.valueDataType==bobj.crv.params.DataTypes.STRING){for(var b=0,a=c.value.length;b<a;b++){if(bobj.isString(c.value[b])){c.value[b]=encodeURIComponent(c.value[b])}else{if(bobj.isObject(c.value[b])){if(c.value[b].beginValue){c.value[b].beginValue=encodeURIComponent(c.value[b].beginValue)}if(c.value[b].endValue){c.value[b].endValue=encodeURIComponent(c.value[b].endValue)}}}}}if(c.paramName){c.paramName=encodeURIComponent(c.paramName)}if(c.reportName){c.reportName=encodeURIComponent(c.reportName)}}return c},_setViewProperty:function(b,c){var a=this._getViewState();if(a){a[b]=c}},_getViewProperty:function(b){var a=this._getViewState();if(a){return a[b]}return null},_setCommonProperty:function(b,c){var a=this._getCommonState();if(a){a[b]=c}},_getCommonProperty:function(b){var a=this._getCommonState();if(a){return a[b]}return null},_updateUIState:function(a){},_getViewState:function(){var a=bobj.crv.stateManager.getComponentState(this._name);if(a&&a.curViewId){return a[a.curViewId]}return null},_getCommonState:function(){var a=bobj.crv.stateManager.getComponentState(this._name);if(a){return a.common}return null},_setInteractiveParams:function(c){if(!this._ioHandler.canUseAjax()){var d=this._viewer.getParameterPanel();if(d){d.showError(L_bobj_crv_InteractiveParam_NoAjax)}return}if(!c){var b=this._getCommonProperty("iactParams");if(b){var f=bobj.crv.params.Parameter;var c=[];for(var e=0;e<b.length;++e){c.push(new f(b[e]))}}}if(c&&c.length){var d=this._viewer.getParameterPanel();if(d){var a=this._getCommonProperty("paramOpts");this._paramCtrl=new bobj.crv.params.ParameterController(d,this,a);this._paramCtrl.setParameters(c)}}},_updateInteractiveParams:function(c){if(c.resolvedFields){this._viewer.hidePromptDialog();for(var a=0;a<c.resolvedFields.length;a++){var b=new bobj.crv.params.Parameter(c.resolvedFields[a]);this._paramCtrl.updateParameter(b.paramName,b.getValue())}this._paramCtrl._updateToolbar()}else{this._viewer.showPromptDialog(c.html)}},_request:function(f,e,h,a){var g=bobj.crv.stateManager.getCompositeState();var d=MochiKit.Base.bind;var b=d(this._onResponse,this,a,f);var c=d(this._onIOError,this);if(!bobj.isBoolean(h)){h=true}if(this._reportProcessing&&h){this._reportProcessing.delayedShow(false)}var i=this._ioHandler.request(g,this._name,f,e,b,c);if(i){if(this._reportProcessing&&h){this._reportProcessing.setDeferred(i)}i.addCallback(b);i.addErrback(c)}},_onResponse:function(a,f,b){var e=null;if(bobj.isString(b)){e=MochiKit.Base.evalJSON(b)}else{e=MochiKit.Async.evalJSONRequest(b)}if(e){if(e.needsReload){this._request(f,false,true,a);return}if(e.status&&this._viewer&&(e.status.errorMessage||e.status.debug)){var c=e.status.errorMessage||L_bobj_crv_RequestError;this._viewer.showError(c,e.status.debug)}if(e.state){var d=e.state;if(bobj.isString(d)){d=MochiKit.Base.evalJSON(d)}bobj.crv.stateManager.setComponentState(this._name,d)}if(e.update&&e.update.promptDlg){this._updateInteractiveParams(e.update.promptDlg);bobj.crv.logger.info("Update InteractiveParams")}if(e.update&&this._viewer&&a){this._viewer.update(e.update,a);bobj.crv.logger.info("Update Viewer")}}if(this._reportProcessing){this._reportProcessing.cancelShow()}},_onIOError:function(b){if(this._reportProcessing.wasCancelled()==true){return}if(this._viewer){var c=this._ioHandler.processError(b);var a="";if(bobj.isString(c)){a=c}else{for(var d in c){if(bobj.isString(c[d])||bobj.isNumber(c[d])){a+=d+": "+c[d]+"\n"}}}this._viewer.showError(L_bobj_crv_RequestError,a)}if(this._reportProcessing){this._reportProcessing.cancelShow()}},_saveViewState:function(){var a=bobj.crv.stateManager.getCompositeState();this._ioHandler.saveViewState(a,this._name)},_addRequestFields:function(b){var c=document.getElementById(b);if(c){for(var a in c){var d=c[a];if(d&&d.name&&d.value){this._addRequestField(d.name,d.value)}}}},_addRequestFieldsFromContent:function(e){var b=document.getElementById(e);if(!b){return}var c=MochiKit.DOM.getElementsByTagAndClassName("input",null,b);for(var a in c){var d=c[a];if(d&&d.name&&d.value){this._addRequestField(d.name,d.value)}}},_addRequestField:function(a,b){this._ioHandler.addRequestField(a,b)},_removeRequestField:function(a){this._ioHandler.removeRequestField(a)},_onHyperlinkClicked:function(d){d=MochiKit.Base.parseQueryString(d);var b=this._viewer.getEventListeners("hyperlinkClicked");var f=false;if(b){for(var e=0,c=b.length;e<c;e++){if(b[e](d)==true){f=true}}}if(f){return}var a=window;if(d.target&&d.target!="_self"){a.open(d.url,d.target)}else{a.location=d.url}}};